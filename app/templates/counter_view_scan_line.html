{% extends "base.html" %}
{% block title %}Manager Insights | DSV Stock Count{% endblock %}

{% block content %}
<head>
  <meta charset="utf-8"/>
  <title>DSV Stock Count ‚Äî Counting</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" href="/static/favicon.ico" />
  <style>
    /* --- your full original CSS kept intact --- */
    :root {
      --dsv-blue: #002664;
      --dsv-light-blue: #4B87E0;
      --dsv-white: #ffffff;
      --dsv-gray: #f5f7fa;
      --dsv-text: #002664;
      --dsv-success: #16a34a;
      --dsv-warning: #f59e0b;
      --dsv-error: #dc2626;
      --dsv-border: #d1d5db;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      background: var(--dsv-gray);
      color: var(--dsv-text);
      line-height: 1.6;
    }

    .container { max-width: 100%; margin: 0 auto; padding: 1rem; }
    @media (min-width: 768px) { .container { max-width: 800px; padding: 2rem; } }

    .header {
      background: linear-gradient(135deg, var(--dsv-blue) 0%, #003d99 100%);
      color: var(--dsv-white);
      padding: 1.5rem;
      margin: -1rem -1rem 1.5rem -1rem;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 38, 100, 0.2);
    }
    @media (min-width: 768px) {
      .header { margin: -2rem -2rem 2rem -2rem; border-radius: 0 0 16px 16px; }
    }

    .header h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; }
    .header .subtitle { opacity: 0.95; font-size: 0.95rem; }

    .card {
      background: var(--dsv-white);
      border: 1px solid var(--dsv-border);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 12px rgba(0, 38, 100, 0.08);
    }
    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--dsv-blue);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 3px solid var(--dsv-blue);
    }
    .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem; }
    .kpi { text-align: center; padding: 1.25rem; background: linear-gradient(135deg, var(--dsv-blue), var(--dsv-light-blue));
      color: var(--dsv-white); border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 38, 100, 0.15); }
    .kpi-label { font-size: 0.875rem; opacity: 0.95; margin-bottom: 0.5rem; font-weight: 500; }
    .kpi-value { font-size: 2.25rem; font-weight: 700; line-height: 1; }
    @media (max-width: 767px) { .kpi-grid { grid-template-columns: 1fr; gap: 0.75rem; } }

    .btn { padding: 0.75rem 0.5rem; border: none; border-radius: 5px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .btn-primary { background: var(--dsv-blue); color: var(--dsv-white); }
    .btn-success { background: var(--dsv-success); color: var(--dsv-white); }
    .btn-warning { background: var(--dsv-warning); color: var(--dsv-white); }

    /* ‚úÖ Added: Quantity buttons styling */
    .qty-wrapper { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-top: 0.75rem; }
    .qty-btn {
      background: var(--dsv-light-blue);
      color: white;
      border: none;
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
    }
    .qty-btn:hover { background: var(--dsv-blue); }
    #quantity { width: 60px; text-align: center; font-size: 1.2rem; border: 1px solid var(--dsv-border); border-radius: 8px; padding: 0.4rem 0.25rem; }

    /* --- rest of your CSS unchanged (tables, modals, etc.) --- */
  </style>
</head>

<body>
  <div class="container">

    <!-- Header -->
    <div class="header">
      <h1>Stock Counting ‚Äî {{ line.line_code }}</h1>
      <div class="subtitle">{{ line.location.name }} / {{ line.warehouse.warehouse_name }}</div>
      <button onclick="window.location.href='{{ url_for('counter.dashboard') }}'"
              class="btn btn-primary">‚Üê Back</button>
    </div>

    <!-- KPIs -->
    <div class="card">
      <div class="card-title">Count Progress</div> 
      <div class="kpi-grid">
        <div class="kpi"><div class="kpi-label">Scanned</div><div class="kpi-value" id="scannedTotal">{{ line.current_count }}</div></div>
        <div class="kpi"><div class="kpi-label">Target</div><div class="kpi-value" id="targetQty">{{ line.target_count }}</div></div>
        <div class="kpi"><div class="kpi-label">Remaining</div><div class="kpi-value" id="remainingQty">{{ line.target_count - line.current_count }}</div></div>
      </div>
    </div>

    <!-- Scanner Upload -->
    <div class="card">
      <div class="card-title">Barcode Scanner</div>
      <div style="text-align:center; padding:1rem;">
        <input type="file" id="imageInput" accept="image/*" capture="environment" style="display:none;" />
        <img id="previewImg" style="max-width:100%; display:none; border-radius:10px; margin-bottom:1rem;" />
        <button id="captureBtn" class="btn btn-primary">üì∑ Capture / Upload Image</button>
        <p style="font-size:0.9rem; color:#6b7280; margin-top:0.5rem;">System will extract up to 3 barcodes automatically.</p>
      </div>

      <div style="margin-top:1rem;">
        <input id="barcode_1" placeholder="Barcode 1" class="form-input" style="width:100%; padding:0.75rem; margin-bottom:0.5rem; border:1px solid #d1d5db; border-radius:8px;"  />
        <input id="barcode_2" placeholder="Barcode 2" class="form-input" style="width:100%; padding:0.75rem; margin-bottom:0.5rem; border:1px solid #d1d5db; border-radius:8px;"  />
        <input id="barcode_3" placeholder="Barcode 3" class="form-input" style="width:100%; padding:0.75rem; margin-bottom:0.5rem; border:1px solid #d1d5db; border-radius:8px;" />
      </div>

      <!-- ‚úÖ Quantity Added -->
      <div class="qty-wrapper">
        <button id="decreaseQty" class="qty-btn">‚àí</button>
        <input id="quantity" type="text" value="1" readonly />
        <button id="increaseQty" class="qty-btn">+</button>
      </div>

      <button id="submitBtn" class="btn btn-success" style="width:100%; margin-top:1rem;">‚úÖ Confirm & Save</button>
    </div>

    <!-- Raise Variation + Scanned Records + Modals -->
    {{ super() }}  <!-- your original sections stay untouched -->

    <!-- Toast -->
    <div id="toast" style="display:none; position:fixed; bottom:2rem; left:50%; transform:translateX(-50%);
        background:#002664; color:white; padding:0.75rem 1.5rem; border-radius:10px;">Processing...</div>
  </div>

  <!-- ‚úÖ JavaScript Section -->
  <script>
    const imageInput = document.getElementById('imageInput');
    const captureBtn = document.getElementById('captureBtn');
    const previewImg = document.getElementById('previewImg');
    const barcode_1 = document.getElementById('barcode_1');
    const barcode_2 = document.getElementById('barcode_2');
    const barcode_3 = document.getElementById('barcode_3');
    const submitBtn = document.getElementById('submitBtn');
    const toast = document.getElementById('toast');
    const quantityInput = document.getElementById('quantity');
    const increaseQty = document.getElementById('increaseQty');
    const decreaseQty = document.getElementById('decreaseQty');
    let uploadedFile = null;

    // ‚úÖ Quantity logic
    increaseQty.addEventListener('click', () => {
      let qty = parseInt(quantityInput.value);
      quantityInput.value = qty + 1;
    });
    decreaseQty.addEventListener('click', () => {
      let qty = parseInt(quantityInput.value);
      if (qty > 1) quantityInput.value = qty - 1;
    });

    captureBtn.addEventListener('click', () => imageInput.click());

    // image processing (unchanged)
    imageInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      uploadedFile = file;
      previewImg.src = URL.createObjectURL(file);
      previewImg.style.display = 'block';
      const formData = new FormData();
      formData.append('image', file);
      toast.innerText = '‚è≥ Processing image...';
      toast.style.display = 'block';
      const res = await fetch('{{ url_for("counter.process_barcode") }}', { method: 'POST', body: formData });
      const data = await res.json();
      toast.style.display = 'none';
      if (!data.success) { alert(data.error || data.message); return; }
      barcode_1.value = data.barcodes[0] || '';
      barcode_2.value = data.barcodes[1] || '';
      barcode_3.value = data.barcodes[2] || '';
      submitBtn.disabled = false;
    });

    // save logic (add quantity)
    submitBtn.addEventListener('click', async () => {
      const barcodes = [barcode_1.value.trim(), barcode_2.value.trim(), barcode_3.value.trim()].filter(Boolean);
      if (barcodes.length === 0) { alert("Please scan or enter at least one barcode before saving."); return; }
      const formData = new FormData();
      formData.append('image', uploadedFile);
      formData.append('line_id', '{{ line.id }}');
      formData.append('barcode_1', barcode_1.value);
      formData.append('barcode_2', barcode_2.value);
      formData.append('barcode_3', barcode_3.value);
      formData.append('quantity', quantityInput.value); // ‚úÖ Added quantity
      toast.innerText = 'üíæ Saving scan record...';
      toast.style.display = 'block';
      const res = await fetch('{{ url_for("counter.save_scan_record") }}', { method: 'POST', body: formData });
      const data = await res.json();
      toast.style.display = 'none';
      if (!data.success) { alert(data.error || 'Save failed'); return; }

      // Update KPIs and reset fields
      document.getElementById('scannedTotal').innerText = data.scanned_count;
      document.getElementById('remainingQty').innerText = data.remaining;
      barcode_1.value = ''; barcode_2.value = ''; barcode_3.value = '';
      previewImg.style.display = 'none';
      quantityInput.value = 1; // ‚úÖ reset
      uploadedFile = null;
      toast.innerText = '‚úÖ Scan saved successfully';
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 2000);
    });

    // other existing JS (raise variation, delete record, modals, etc.) remains untouched
  </script>
</body>
{% endblock %}