<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manager Dashboard - DSV Stock Count</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-blue-900 mb-6 text-center">Manager Dashboard</h1>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="p-3 mb-3 rounded text-white text-center
            {% if category == 'success' %}bg-green-500{% else %}bg-red-500{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Insights button -->
    <div class="text-right mb-6">
      <a href="{{ url_for('manager.insights') }}"
         class="text-white py-2 px-4 rounded-lg bg-blue-900 hover:bg-blue-800 transition">
         📊 View Insights
      </a>
    </div>
    <!-- Logout -->
    <div class="text-center mt-6">
      <a href="{{ url_for('auth.logout') }}"
         class="text-red-600 font-semibold hover:underline">
         Logout
      </a>
    </div>

    <!-- Users Table -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">All Users</h2>
      <button id="openAddUserModal" 
              class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition mb-4">
        + Add New User
      </button>

      <table class="w-full border border-gray-300 text-left">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2 border-b">#</th>
            <th class="p-2 border-b">Username</th>
            <th class="p-2 border-b">Role</th>
            <th class="p-2 border-b">Status</th>
            <th class="p-2 border-b text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr class="hover:bg-gray-50">
            <td class="p-2 border-b">{{ loop.index }}</td>
            <td class="p-2 border-b">{{ user.username }}</td>
            <td class="p-2 border-b">{{ user.role }}</td>
            <td class="p-2 border-b">
              {% if user.is_active %}
                <span class="text-green-600 font-semibold">Active</span>
              {% else %}
                <span class="text-red-600 font-semibold">Disabled</span>
              {% endif %}
            </td>
            <td class="p-2 border-b text-center space-x-2">
              <a href="{{ url_for('manager.toggle_user', user_id=user.id) }}"
                 class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded">
                 {% if user.is_active %}Disable{% else %}Enable{% endif %}
              </a>
              <button onclick="openEditUserModal({{ user.id }}, '{{ user.username }}', '{{ user.role }}')"
                      class="text-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
                Edit
              </button>
              <button onclick="openPasswordModal({{ user.id }}, '{{ user.username }}')"
                      class="text-sm bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-1 rounded">
                Reset Password
              </button>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="5" class="p-4 text-center text-gray-500">No users yet</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Locations Table -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">Locations</h2>
      <button id="openAddLocationModal"
              class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition mb-4">
        + Add Location
      </button>

      <table class="w-full border border-gray-300 text-left">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2 border-b">#</th>
            <th class="p-2 border-b">Location Name</th>
            <th class="p-2 border-b">Created By</th>
            <th class="p-2 border-b">Created On</th>
            <th class="p-2 border-b text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for location in locations %}
          <tr class="hover:bg-gray-50">
            <td class="p-2 border-b">{{ loop.index }}</td>
            <td class="p-2 border-b">{{ location.name }}</td>
            <td class="p-2 border-b">{{ location.created_by or '-' }}</td>
            <td class="p-2 border-b">{{ location.created_on.strftime('%Y-%m-%d') }}</td>
            <td class="p-2 border-b text-center">
              <button onclick="openEditLocationModal({{ location.id }}, '{{ location.name }}')"
                      class="text-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
                Edit
              </button>
              <a href="{{ url_for('manager.delete_location', location_id=location.id) }}"
                 class="text-sm bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded"
                 onclick="return confirm('Delete this location?');">
                 Delete
              </a>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="5" class="p-4 text-center text-gray-500">No locations yet</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Warehouses Table -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">Warehouses</h2>
      <button id="openAddWarehouseModal"
              class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition mb-4">
        + Add Warehouse
      </button>

      <table class="w-full border border-gray-300 text-left">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2 border-b">#</th>
            <th class="p-2 border-b">Warehouse Name</th>
            <th class="p-2 border-b">Linked Location</th>
            <th class="p-2 border-b">Created By</th>
            <th class="p-2 border-b">Created On</th>
            <th class="p-2 border-b text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for warehouse in warehouses %}
          <tr class="hover:bg-gray-50">
            <td class="p-2 border-b">{{ loop.index }}</td>
            <td class="p-2 border-b">{{ warehouse.warehouse_name }}</td>
            <td class="p-2 border-b">{{ warehouse.location.name }}</td>
            <td class="p-2 border-b">{{ warehouse.created_by or '-' }}</td>
            <td class="p-2 border-b">{{ warehouse.created_on.strftime('%Y-%m-%d') }}</td>
            <td class="p-2 border-b text-center">
              <button onclick="openEditWarehouseModal({{ warehouse.id }}, '{{ warehouse.warehouse_name }}', {{ warehouse.location.id }})"
                      class="text-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
                Edit
              </button>
              <a href="{{ url_for('manager.delete_warehouse', warehouse_id=warehouse.id) }}"
                 class="text-sm bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded"
                 onclick="return confirm('Delete this warehouse?');">Delete</a>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="6" class="p-4 text-center text-gray-500">No warehouses yet</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>

  <div id="addUserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
    <h2 class="text-xl font-semibold mb-4">Add New User</h2>
    <form method="POST" action="{{ url_for('manager.add_user') }}">
      <div class="mb-3">
        <label class="block text-sm mb-1">Username</label>
        <input name="username" id="usernameInput" type="text" class="w-full border p-2 rounded" required>
        <p id="usernameWarning" class="text-red-600 text-sm mt-1 hidden">Username already exists!</p>
      </div>
      <div class="mb-3">
        <label class="block text-sm mb-1">Password</label>
        <input name="password" type="password" class="w-full border p-2 rounded" required>
      </div>
      <div class="mb-3">
        <label class="block text-sm mb-1">Role</label>
        <select name="role" class="w-full border p-2 rounded" required>
          <option value="">Select role</option>
          <option value="TeamLeader">Team Leader</option>
          <option value="Counter">Counter</option>
        </select>
      </div>
      <div class="flex justify-end space-x-3 mt-4">
        <button type="button" id="closeAddUserModal" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Add</button>
      </div>
    </form>
  </div>
</div>

<div id="passwordModal"
     class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
    <button id="closePasswordModal"
            type="button"
            class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">✕</button>

    <h2 id="passwordModalTitle" class="text-xl font-semibold mb-4">Reset Password</h2>

    <!-- action is set dynamically in JS: /manager/update_password/<id> -->
    <form id="passwordForm" method="POST">
      <input type="hidden" id="passwordUserId" name="user_id" />

      <div class="mb-3">
        <label class="block text-sm mb-1">New Password</label>
        <input id="newPasswordInput"
               name="new_password"
               type="password"
               class="w-full border p-2 rounded"
               required />
      </div>

      <div class="flex justify-end space-x-3 mt-4">
        <button type="button"
                id="closePasswordModalBtn"
                class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">
          Cancel
        </button>
        <button type="submit"
                class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
          Update
        </button>
      </div>
    </form>
  </div>
</div>

<div id="editUserModal"
     class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
    <button id="closeEditUserModal"
            type="button"
            class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">✕</button>

    <h2 id="editUserModalTitle" class="text-xl font-semibold mb-4">Edit User</h2>

    <form id="editUserForm" method="POST">
      <!-- action is set dynamically via JS -->
      <div class="mb-3">
        <label class="block text-sm mb-1">Username</label>
        <input id="editUsername" name="username" type="text" class="w-full border p-2 rounded" required />
      </div>

      <div class="flex justify-end space-x-3 mt-4">
        <button type="button" id="closeEditUserModalBtn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update</button>
      </div>
    </form>
  </div>
</div>

  <!-- Add Location Modal -->
  <div id="addLocationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
      <h2 class="text-xl font-semibold mb-4">Add New Location</h2>
      <form method="POST" action="{{ url_for('manager.add_location') }}">
        <div class="mb-3">
          <label class="block text-sm mb-1">Location Name</label>
          <input name="name" type="text" class="w-full border p-2 rounded" required>
        </div>
        <div class="flex justify-end space-x-3 mt-4">
          <button type="button" id="closeAddLocationModal" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Add</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Location Modal -->
<div id="editLocationModal"
     class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
    <button id="closeEditLocationModal"
            type="button"
            class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">✕</button>

    <h2 id="editLocationModalTitle" class="text-xl font-semibold mb-4">Edit Location</h2>

    <form id="editLocationForm" method="POST">
      <!-- Action set dynamically -->
      <div class="mb-3">
        <label class="block text-sm mb-1">Location Name</label>
        <input id="editLocationName" name="name" type="text" class="w-full border p-2 rounded" required />
      </div>

      <div class="flex justify-end space-x-3 mt-4">
        <button type="button" id="closeEditLocationModalBtn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update</button>
      </div>
    </form>
  </div>
</div>

  <!-- Add Warehouse Modal -->
  <div id="addWarehouseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
      <h2 class="text-xl font-semibold mb-4">Add New Warehouse</h2>
      <form method="POST" action="{{ url_for('manager.add_warehouse') }}">
        <div class="mb-3">
          <label class="block text-sm mb-1">Warehouse Name</label>
          <input name="warehouse_name" type="text" class="w-full border p-2 rounded" required>
        </div>
        <div class="mb-3">
          <label class="block text-sm mb-1">Linked Location</label>
          <select name="location_id" class="w-full border p-2 rounded" required>
            {% for location in locations %}
            <option value="{{ location.id }}">{{ location.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex justify-end space-x-3 mt-4">
          <button type="button" id="closeAddWarehouseModal" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Add</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Warehouse Modal -->
<div id="editWarehouseModal"
     class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
    <button id="closeEditWarehouseModal"
            type="button"
            class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">✕</button>

    <h2 id="editWarehouseModalTitle" class="text-xl font-semibold mb-4">Edit Warehouse</h2>

    <form id="editWarehouseForm" method="POST">
      <!-- Action set in JS -->
      <div class="mb-3">
        <label class="block text-sm mb-1">Warehouse Name</label>
        <input id="editWarehouseName" name="warehouse_name" type="text" class="w-full border p-2 rounded" required />
      </div>

      <div class="mb-3">
        <label class="block text-sm mb-1">Linked Location</label>
        <select id="editWarehouseLocation" name="location_id" class="w-full border p-2 rounded" required>
          {% for location in locations %}
          <option value="{{ location.id }}">{{ location.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="flex justify-end space-x-3 mt-4">
        <button type="button" id="closeEditWarehouseModalBtn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update</button>
      </div>
    </form>
  </div>
</div>

  <!-- Existing modals and JS from before -->
<script>
document.addEventListener("DOMContentLoaded", function() {

  // ========== Add User Modal ==========
  const addUserModal = document.getElementById("addUserModal");
  const openAddUserBtn = document.getElementById("openAddUserModal");
  const closeAddUserBtn = document.getElementById("closeAddUserModal");

  if (openAddUserBtn && addUserModal && closeAddUserBtn) {
    openAddUserBtn.addEventListener("click", () => addUserModal.classList.remove("hidden"));
    closeAddUserBtn.addEventListener("click", () => addUserModal.classList.add("hidden"));
  }

  // ========== Password Modal ==========
  const passwordModal = document.getElementById("passwordModal");
  const closePasswordModal = document.getElementById("closePasswordModal");
  const passwordForm = document.getElementById("passwordForm");

  window.openPasswordModal = function(id, username) {
    document.getElementById("passwordUserId").value = id;
    document.getElementById("passwordModalTitle").innerText = `Reset Password for ${username}`;
    passwordForm.action = `/manager/update_password/${id}`;
    passwordModal.classList.remove("hidden");
  };

  if (closePasswordModal && passwordModal) {
    closePasswordModal.addEventListener("click", () => passwordModal.classList.add("hidden"));
  }

  // ========== Edit User Modal ==========
const editUserModal = document.getElementById("editUserModal");
const closeEditUserModal = document.getElementById("closeEditUserModal");
const closeEditUserModalBtn = document.getElementById("closeEditUserModalBtn");
const editUserForm = document.getElementById("editUserForm");

window.openEditUserModal = function (userId, username, role) {
  // Set form action
  editUserForm.action = `/manager/edit_user/${userId}`;
  // Set values
  document.getElementById("editUsername").value = username;
  document.getElementById("editUserModalTitle").innerText = `Edit User: ${username}`;
  // Show modal
  editUserModal.classList.remove("hidden");
};

if (closeEditUserModal) {
  closeEditUserModal.addEventListener("click", () => editUserModal.classList.add("hidden"));
}
if (closeEditUserModalBtn) {
  closeEditUserModalBtn.addEventListener("click", () => editUserModal.classList.add("hidden"));
}
  // ========== Add Location Modal ==========
  const addLocationModal = document.getElementById("addLocationModal");
  const openAddLocationBtn = document.getElementById("openAddLocationModal");
  const closeAddLocationBtn = document.getElementById("closeAddLocationModal");

  if (openAddLocationBtn && addLocationModal && closeAddLocationBtn) {
    openAddLocationBtn.addEventListener("click", () => addLocationModal.classList.remove("hidden"));
    closeAddLocationBtn.addEventListener("click", () => addLocationModal.classList.add("hidden"));
  }

  // ===== Edit Location Modal =====
const editLocationModal = document.getElementById("editLocationModal");
const closeEditLocationModal = document.getElementById("closeEditLocationModal");
const closeEditLocationModalBtn = document.getElementById("closeEditLocationModalBtn");
const editLocationForm = document.getElementById("editLocationForm");

window.openEditLocationModal = function (id, name) {
  editLocationForm.action = `/manager/edit_location/${id}`;
  document.getElementById("editLocationName").value = name;
  document.getElementById("editLocationModalTitle").innerText = `Edit Location: ${name}`;
  editLocationModal.classList.remove("hidden");
};

closeEditLocationModal?.addEventListener("click", () => editLocationModal.classList.add("hidden"));
closeEditLocationModalBtn?.addEventListener("click", () => editLocationModal.classList.add("hidden"));

  // ========== Add Warehouse Modal ==========
  const addWarehouseModal = document.getElementById("addWarehouseModal");
  const openAddWarehouseBtn = document.getElementById("openAddWarehouseModal");
  const closeAddWarehouseBtn = document.getElementById("closeAddWarehouseModal");

  if (openAddWarehouseBtn && addWarehouseModal && closeAddWarehouseBtn) {
    openAddWarehouseBtn.addEventListener("click", () => addWarehouseModal.classList.remove("hidden"));
    closeAddWarehouseBtn.addEventListener("click", () => addWarehouseModal.classList.add("hidden"));
  }

  // ===== Edit Warehouse Modal =====
const editWarehouseModal = document.getElementById("editWarehouseModal");
const closeEditWarehouseModal = document.getElementById("closeEditWarehouseModal");
const closeEditWarehouseModalBtn = document.getElementById("closeEditWarehouseModalBtn");
const editWarehouseForm = document.getElementById("editWarehouseForm");

window.openEditWarehouseModal = function (id, name, locationId) {
  editWarehouseForm.action = `/manager/edit_warehouse/${id}`;
  document.getElementById("editWarehouseName").value = name;
  document.getElementById("editWarehouseLocation").value = locationId;
  document.getElementById("editWarehouseModalTitle").innerText = `Edit Warehouse: ${name}`;
  editWarehouseModal.classList.remove("hidden");
};

closeEditWarehouseModal?.addEventListener("click", () => editWarehouseModal.classList.add("hidden"));
closeEditWarehouseModalBtn?.addEventListener("click", () => editWarehouseModal.classList.add("hidden"));

  // Optional UX: click outside modal to close
  document.querySelectorAll(".fixed.bg-black.bg-opacity-50").forEach(overlay => {
    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) overlay.classList.add("hidden");
    });
  });
});

async function checkDuplicate(type, value) {
  const res = await fetch("{{ url_for('manager.check_duplicate') }}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ type, value }),
  });
  return res.json();
}

const usernameInput = document.getElementById("usernameInput");
const usernameWarning = document.getElementById("usernameWarning");

if (usernameInput) {
  usernameInput.addEventListener("blur", async () => {
    const value = usernameInput.value.trim();
    if (!value) return;
    const { exists } = await checkDuplicate("user", value);
    usernameWarning.classList.toggle("hidden", !exists);
  });
}

// ===== Add User Validation =====
const addUserForm = document.querySelector('form[action="{{ url_for("manager.add_user") }}"]');
if (addUserForm) {
  addUserForm.addEventListener("submit", async (e) => {
    const username = addUserForm.querySelector('[name="username"]').value.trim();
    if (!username) return;

    const { exists } = await checkDuplicate("user", username);
    if (exists) {
      e.preventDefault();
      alert("❌ Username already exists. Please choose another one.");
    }
  });
}

// ===== Add Location Validation =====
const addLocationForm = document.querySelector('form[action="{{ url_for("manager.add_location") }}"]');
if (addLocationForm) {
  addLocationForm.addEventListener("submit", async (e) => {
    const name = addLocationForm.querySelector('[name="name"]').value.trim();
    if (!name) return;

    const { exists } = await checkDuplicate("location", name);
    if (exists) {
      e.preventDefault();
      alert("⚠️ Location name already exists. Please choose another name.");
    }
  });
}

// ===== Add Warehouse Validation =====
const addWarehouseForm = document.querySelector('form[action="{{ url_for("manager.add_warehouse") }}"]');
if (addWarehouseForm) {
  addWarehouseForm.addEventListener("submit", async (e) => {
    const name = addWarehouseForm.querySelector('[name="warehouse_name"]').value.trim();
    if (!name) return;

    const { exists } = await checkDuplicate("warehouse", name);
    if (exists) {
      e.preventDefault();
      alert("⚠️ Warehouse name already exists. Please choose another name.");
    }
  });
}
</script>
</body>
</html>